<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Digital Angel Oracle Coach</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFEFF7">

  <style>
    :root{
      --cardW:min(78vw,350px);

      /* theme tokens */
      --bg1:#ffeef7; --bg2:#e4f3ff;
      --ink:#533d3d;
      --accent:#ffbdd2;
      --accentSoft:#ffe5ef;
      --cream:rgba(255,255,255,0.9);
      --chipBorder:#ffd7e6;
      --chipText:#a2566d;
      --hint:#b45c74;
      --shadow:rgba(0,0,0,0.12);
      --glow:rgba(255,145,180,.30);

      /* ‚úÖ FIX: orbit distance vars */
      --orbitX:200px;
      --orbitYTop:-40px;
      --orbitYBot:170px;
    }

    /* ===== Themes ===== */
    body[data-theme="pink"]{
      --bg1:#ffeef6; --bg2:#e9f3ff;
      --ink:#543a3f;
      --accent:#ffb9d6;
      --accentSoft:#ffe1ef;
      --cream:rgba(255,255,255,0.92);
      --chipBorder:#ffd1e7;
      --chipText:#a74f74;
      --hint:#b45c74;
      --shadow:rgba(40,10,20,0.12);
      --glow:rgba(255,145,190,.35);
    }
    body[data-theme="blue"]{
      --bg1:#eaf3ff; --bg2:#f3ecff;
      --ink:#34485a;
      --accent:#b9d6ff;
      --accentSoft:#dce9ff;
      --cream:rgba(255,255,255,0.92);
      --chipBorder:#cfe0ff;
      --chipText:#4d6aa4;
      --hint:#4f6d9f;
      --shadow:rgba(5,25,60,0.12);
      --glow:rgba(140,180,255,.35);
    }
    body[data-theme="cream"]{
      --bg1:#fff7ef; --bg2:#f7f1ff;
      --ink:#5a4634;
      --accent:#f3d3a3;
      --accentSoft:#faecd6;
      --cream:rgba(255,255,255,0.95);
      --chipBorder:#f7e0bd;
      --chipText:#8f6a3e;
      --hint:#a07a4b;
      --shadow:rgba(70,45,10,0.12);
      --glow:rgba(240,200,120,.35);
    }

    body{
      margin:0; min-height:100vh;
      font-family:"Inter",system-ui,-apple-system;
      background:
        radial-gradient(820px circle at 50% 0%, #ffffffc8 0%, transparent 60%),
        linear-gradient(180deg,var(--bg1),var(--bg2));
      display:flex; flex-direction:column; align-items:center;
      padding:18px 12px 34px; color:var(--ink); overflow-x:hidden;
      transition:background .5s ease, color .3s ease;
      position:relative;
    }

    /* ===== Floating angel layer ===== */
    .float-angel-layer{
      position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden;
    }
    .float-angel{
      position:absolute;
      font-size:18px;
      opacity:.35;
      filter: drop-shadow(0 6px 12px rgba(255,170,200,.35));
      animation: floatUp var(--dur,18s) linear infinite;
      left: var(--x,50%);
      top: var(--y,100%);
    }
    @keyframes floatUp{
      0%{ transform:translateY(0) translateX(0) rotate(0deg); opacity:0; }
      10%{ opacity:.35; }
      100%{ transform:translateY(-130vh) translateX(30px) rotate(14deg); opacity:0; }
    }

    /* Header */
    .topbar{
      width:min(96vw,520px);
      display:flex; align-items:center; justify-content:center;
      margin:6px 0 4px;
      position:relative;
      z-index:2;
    }

    /* Title breathing gradient */
    .title{
      font-weight:900;
      letter-spacing:.5px;
      line-height:1.1;
      font-size:clamp(26px,4vw,36px);
      text-align:center;
      white-space:nowrap;

      background: linear-gradient(90deg,#6b3d4a,#ff9fc7,#ffd9a8,#6b3d4a);
      background-size:220% 100%;
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;

      filter:
        drop-shadow(0 1px 0 #fff)
        drop-shadow(0 10px 28px rgba(255,150,190,.45));

      animation:titleBreath 5.5s ease-in-out infinite;
    }
    @keyframes titleBreath{
      0%,100%{ background-position:0% 50%; transform:translateY(0); opacity:.92; }
      50%{ background-position:100% 50%; transform:translateY(-2px); opacity:1; }
    }

    .sub{
      font-size:13px; opacity:.78; margin:2px 0 12px;
      text-align:center;
      z-index:2;
    }

    /* Settings + theme emoji pills (top-right floating) */
    .right-tools{
      position:fixed; top:14px; right:12px; z-index:5;
      display:flex; align-items:center; gap:8px;
    }
    .theme-pills{
      display:flex; gap:6px; padding:6px 8px;
      background:#ffffffd9; border-radius:999px;
      box-shadow:0 6px 16px rgba(0,0,0,0.08);
      border:1px solid #ffffffb0;
      backdrop-filter: blur(6px);
    }
    .theme-pill{
      width:30px; height:30px; border-radius:999px; border:0;
      display:grid; place-items:center; cursor:pointer;
      font-size:16px; background:transparent;
      transition:.2s;
    }
    .theme-pill.active{
      background:var(--accentSoft);
      box-shadow:0 4px 12px var(--glow);
    }
    .gear{
      border:0; cursor:pointer; font-size:19px; background:#ffffffd9;
      width:36px; height:36px; border-radius:999px;
      box-shadow:0 6px 16px rgba(0,0,0,0.08);
      border:1px solid #ffffffb0;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; margin-bottom:14px;
      flex-wrap:wrap; justify-content:center;
      z-index:2;
    }
    .tab{
      padding:6px 12px; background:#ffffffd9; border-radius:999px;
      font-weight:700; font-size:12px;
      cursor:pointer; box-shadow:0 3px 10px rgba(0,0,0,0.08);
      border:1px solid #ffffff80; transition:.2s; user-select:none;
    }
    .tab.active{
      background:var(--accentSoft); border-color:var(--accent);
      box-shadow:0 4px 14px var(--glow);
    }

    /* ‚úÖ FIX: wrap card so orbit buttons are OUTSIDE clipping */
    .card-wrap{
      position:relative;
      width:var(--cardW);
      aspect-ratio:3/5;
      z-index:2;
      overflow:visible; /* allow orbit buttons to float outside */
    }

    /* Card */
    .card{
      width:100%;
      height:100%;
      border-radius:32px;
      overflow:hidden; /* keep image clipped */
      background:#fff;
      position:relative;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 20px 40px var(--shadow);
      transition:transform .35s ease, box-shadow .35s ease;
    }
    .card img{width:100%; height:100%; object-fit:cover;}

    .card.pop{
      transform:translateY(-5px) scale(1.01);
      box-shadow:0 26px 56px var(--glow);
    }

    /* Sparkle */
    .sparkle{
      position:absolute; inset:0; pointer-events:none; opacity:0;
      background:
        radial-gradient(10px 10px at 20% 25%, #fff5, transparent 60%),
        radial-gradient(8px 8px at 70% 20%, #fff5, transparent 60%),
        radial-gradient(11px 11px at 80% 70%, #fff5, transparent 60%),
        radial-gradient(7px 7px at 30% 80%, #fff5, transparent 60%);
      animation:sparkle 1.0s ease;
    }
    @keyframes sparkle{
      0%{opacity:0; transform:scale(.99);}
      25%{opacity:.7;}
      100%{opacity:0; transform:scale(1.01);}
    }

    /* ‚úÖ FIX: bring back micro-event layers */
    .event{ position:absolute; inset:0; pointer-events:none; opacity:0; }
    .event.money{
      background:
        radial-gradient(14px 14px at 20% 70%, rgba(255,220,130,.8), transparent 60%),
        radial-gradient(10px 10px at 70% 28%, rgba(255,240,180,.8), transparent 60%);
      animation:softEvent .8s ease;
    }
    .event.love{
      background:
        radial-gradient(14px 14px at 25% 70%, rgba(255,160,190,.75), transparent 60%),
        radial-gradient(10px 10px at 78% 25%, rgba(255,190,215,.75), transparent 60%);
      animation:softEvent 1s ease;
    }
    .event.self{
      background:
        radial-gradient(12px 12px at 20% 25%, rgba(170,210,255,.8), transparent 60%),
        radial-gradient(10px 10px at 75% 25%, rgba(210,190,255,.8), transparent 60%);
      animation:softEvent .9s ease;
    }
    .event.healing{
      background:
        radial-gradient(140px 80px at 50% 90%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(160px 120px at 50% 20%, rgba(255,230,245,.55), transparent 70%);
      animation:softEvent 1.1s ease;
    }
    @keyframes softEvent{
      0%{opacity:0; transform:scale(.98);}
      30%{opacity:.9;}
      100%{opacity:0; transform:scale(1.02);}
    }

    /* Prompt box */
    .prompt-box{
      position:absolute; top:8%; width:86%;
      background:var(--cream); padding:14px 16px;
      border-radius:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.10);
      border:1.5px solid color-mix(in srgb, var(--accent) 35%, transparent);
      animation:fadeIn .55s ease;
      backdrop-filter: blur(6px);
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(-7px);}
      to{opacity:1; transform:translateY(0);}
    }

    .summary{
      font-size:11.5px; font-weight:900; letter-spacing:.06em;
      text-transform:uppercase; opacity:.78; margin-bottom:6px;
      display:flex; align-items:center; gap:6px;
    }
    .prompt-text{
      font-size:15.5px; line-height:1.6; white-space:pre-line; font-weight:800;
    }
    .prompt-meta{
      margin-top:6px; font-size:11px; opacity:.65;
      letter-spacing:.08em; text-transform:uppercase;
    }

    .energy-row{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;}
    .chip{
      font-size:11px; font-weight:800; padding:4px 8px; border-radius:999px;
      background:#fff; border:1px solid var(--chipBorder); color:var(--chipText);
      box-shadow:0 2px 6px rgba(0,0,0,.05);
    }

    .section{
      margin-top:8px; font-size:12.5px; line-height:1.55;
      background:#fff; border-radius:14px; padding:8px 10px;
      border:1px solid color-mix(in srgb, var(--accentSoft) 65%, #fff);
    }
    .section-title{
      font-weight:900; font-size:10.5px; letter-spacing:.08em;
      text-transform:uppercase; opacity:.7; margin-bottom:3px;
    }

    .hint{
      margin-top:8px; font-size:12px; color:var(--hint);
      display:flex; align-items:center; gap:6px;
    }

    /* ===== Orbit buttons around card ===== */
    .orbit-btns{
      position:absolute; inset:0; pointer-events:none; overflow:visible;
    }
    .orbit-btn{
      pointer-events:auto;
      position:absolute; left:50%; top:50%;
      transform:translate(-50%,-50%) translate(var(--ox),var(--oy));
      width:76px; height:76px; border-radius:999px; border:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:4px;
      font-weight:900; font-size:11px;
      box-shadow:0 10px 26px var(--shadow);
      border:1px solid #ffffffcc;
      backdrop-filter: blur(6px);
      transition:.2s;
    }
    .orbit-btn .ico{ font-size:20px; line-height:1; }
    .orbit-btn .lab{ font-size:11px; letter-spacing:.02em; }

    /* ‚úÖ FIX: use CSS offsets, not inline, so mobile can scale */
    .orbit-btn.draw{ --ox:calc(-1 * var(--orbitX)); --oy:var(--orbitYTop); }
    .orbit-btn.clarify{ --ox:var(--orbitX); --oy:var(--orbitYTop); }
    .orbit-btn.save{ --ox:calc(-1 * var(--orbitX)); --oy:var(--orbitYBot); }
    .orbit-btn.journal{ --ox:var(--orbitX); --oy:var(--orbitYBot); }

    .orbit-btn.draw{
      background:linear-gradient(180deg,#fff,#ffe9f4);
      color:#6b3d4a;
    }
    .orbit-btn.clarify{
      background:linear-gradient(180deg,#fff,#e9f1ff);
      color:#34485a;
    }
    .orbit-btn.save{
      background:linear-gradient(180deg,#fff,#fff3d9);
      color:#7a5b2b;
    }
    .orbit-btn.journal{
      background:linear-gradient(180deg,#fff,#efe9ff);
      color:#4f3f7a;
    }

    .orbit-btn:hover{
      transform:translate(-50%,-50%) translate(var(--ox),var(--oy)) scale(1.06);
    }

    @media (max-width:480px){
      :root{
        --orbitX:150px;
        --orbitYTop:-20px;
        --orbitYBot:130px;
      }
      .orbit-btn{ width:64px; height:64px; font-size:10px; }
      .orbit-btn .ico{ font-size:18px; }
      .orbit-btn .lab{ font-size:10px; }
      .title{ white-space:normal; }
    }

    .footer{
      margin-top:12px; font-size:11px; opacity:.55; text-align:center;
      max-width:520px; line-height:1.4;
      z-index:2;
    }

    /* ===== Modal base ===== */
    .modal{
      position:fixed; inset:0; background:#00000055; display:none;
      align-items:center; justify-content:center; padding:16px; z-index:99;
      backdrop-filter: blur(2px);
    }
    .modal .box{
      width:min(92vw,480px); max-height:80vh; overflow:auto;
      background:rgba(255,255,255,0.97); border-radius:18px;
      padding:14px; box-shadow:0 18px 50px rgba(0,0,0,.2);
      border:2px solid color-mix(in srgb, var(--accent) 40%, transparent);
    }
    .modal .close{
      position:sticky; top:0; background:#fff; padding:7px 10px; border-radius:999px;
      border:1px solid var(--chipBorder); font-weight:900; cursor:pointer; float:right;
    }

    /* Journal */
    .entry{
      background:#fff; border:1px solid color-mix(in srgb, var(--accentSoft) 65%, #fff);
      border-radius:14px; padding:10px 12px; margin:8px 0;
      font-size:13px; line-height:1.55;
    }
    .entry .date{font-size:11px; opacity:.6; margin-bottom:4px;}
    .entry .tag{font-weight:900; font-size:11px; letter-spacing:.06em; opacity:.7; text-transform:uppercase; margin-bottom:2px;}
    .toolbar{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:6px 0 8px;
    }
    select, .tiny-btn{
      font-size:12px; font-weight:800; border-radius:10px; padding:6px 8px;
      background:#fff; border:1px solid var(--chipBorder);
      box-shadow:0 2px 6px rgba(0,0,0,.05);
      cursor:pointer;
    }
    .tiny-btn{border-radius:999px;}

    /* Settings */
    .setting-item{
      background:#fff; border:1px solid color-mix(in srgb, var(--accentSoft) 65%, #fff);
      border-radius:12px; padding:10px 12px; margin:8px 0;
      font-size:13px; line-height:1.5;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .setting-title{font-weight:900;}
    .small-muted{font-size:12px; opacity:.7;}

    @media (max-width: 480px) {
  .theme-and-settings {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 2000;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 6px 10px;
  }

  h1 {
    margin-top: 80px !important;
  }
}
  </style>
</head>

<body data-theme="pink">

  <!-- floating angels -->
  <div class="float-angel-layer" aria-hidden="true">
    <span class="float-angel" style="--x:8%;  --y:105%; --dur:50s;">ü™Ω</span>
    <span class="float-angel" style="--x:24%; --y:110%; --dur:60s;">üëº</span>
    <span class="float-angel" style="--x:52%; --y:108%; --dur:30s;">ü™Ω</span>
    <span class="float-angel" style="--x:70%; --y:112%; --dur:40s;">üëº</span>
    <span class="float-angel" style="--x:88%; --y:106%; --dur:30s;">ü™Ω</span>
  </div>

  <!-- right tools -->
  <div class="right-tools">
    <div class="theme-pills" id="themeRow">
      <button class="theme-pill" data-theme="pink" aria-label="Pink theme">üå∏</button>
      <button class="theme-pill" data-theme="blue" aria-label="Blue theme">ü™Ω</button>
      <button class="theme-pill" data-theme="cream" aria-label="Cream theme">‚ú®</button>
    </div>
    <button class="gear" id="openSettings" aria-label="Settings">‚öôÔ∏è</button>
  </div>

  <div class="topbar">
    <div class="title">Digital Angel Oracle Coach</div>
  </div>
  <div class="sub">Your daily gentle guidance.</div>

  <!-- Category Tabs -->
  <div class="tabs" id="tabs"></div>

  <!-- ‚úÖ FIX: card-wrap added -->
  <div class="card-wrap" id="cardWrap">

    <div class="card" id="card">
      <img id="cardBackImg" src="cards/back.png" alt="">
      <div class="sparkle" id="sparkle"></div>
      <div class="event" id="eventLayer"></div>

      <!-- Prompt float box -->
      <div class="prompt-box" id="promptBox">
        <div class="summary">
          <span>‚ú®</span>
          <span id="summaryText">Today‚Äôs Guidance will appear here.</span>
        </div>

        <div class="prompt-text" id="promptText">Tap ‚ÄúDraw‚Äù to begin.</div>
        <div class="prompt-meta" id="promptMeta"></div>

        <div class="energy-row" id="energyRow"></div>

        <div class="section" id="actionBox" style="display:none;">
          <div class="section-title">Action Step</div>
          <div id="actionText"></div>
        </div>

        <div class="section" id="affBox" style="display:none;">
          <div class="section-title">Affirmation</div>
          <div id="affText"></div>
        </div>

        <div class="hint">
          <span>üåü</span>
          <span id="hintText">Today's Hint will appear here.</span>
        </div>
      </div>
    </div>

    <!-- Orbit buttons with labels -->
    <div class="orbit-btns" aria-label="Actions">
      <button class="orbit-btn draw" id="drawBtn">
        <span class="ico">ü™Ñ</span><span class="lab">Draw</span>
      </button>
      <button class="orbit-btn clarify" id="clarifyBtn">
        <span class="ico">‚ú®</span><span class="lab">Clarify</span>
      </button>
      <button class="orbit-btn save" id="saveBtn">
        <span class="ico">üíó</span><span class="lab">Save</span>
      </button>
      <button class="orbit-btn journal" id="journalBtn">
        <span class="ico">üìú</span><span class="lab">Journal</span>
      </button>
    </div>

  </div>

  <div class="footer">
    Works offline ‚Ä¢ Mobile friendly ‚Ä¢ Add to Home Screen<br>
    Your saved prompts stay on your device (no account needed).
  </div>

  <!-- Journal Modal -->
  <div class="modal" id="journalModal">
    <div class="box">
      <button class="close" id="closeJournal">Close</button>
      <h3 style="margin:4px 0 8px;">My Journal ‚ú®</h3>

      <div class="toolbar">
        <label class="small-muted">Filter:</label>
        <select id="filterSelect">
          <option value="All">All</option>
          <option value="Money">Money</option>
          <option value="Love">Love</option>
          <option value="Self">Self</option>
          <option value="Healing">Healing</option>
        </select>
        <button class="tiny-btn" id="exportBtn">Export TXT</button>
        <button class="tiny-btn" id="clearBtn">Clear All</button>
      </div>

      <div id="journalList"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="box">
      <button class="close" id="closeSettings">Close</button>
      <h3 style="margin:4px 0 8px;">Settings</h3>

      <div class="setting-item">
        <div>
          <div class="setting-title">Daily Mode</div>
          <div class="small-muted">1 main draw per day. Opens with today‚Äôs message.</div>
        </div>
        <input type="checkbox" id="dailyToggle">
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-title">Change Card Back</div>
          <div class="small-muted">Use your own image for the back.</div>
        </div>
        <input type="file" id="backUploader" accept="image/*">
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-title">Restore Default Card Back</div>
          <div class="small-muted">Removes your uploaded image and resets to original.</div>
        </div>
        <button class="tiny-btn" id="restoreBackBtn">Reset</button>
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-title">Copy Current Prompt</div>
          <div class="small-muted">Copies the prompt text to clipboard.</div>
        </div>
        <button class="tiny-btn" id="copyBtn">Copy</button>
      </div>

      <div class="setting-item">
        <div>
          <div class="setting-title">Reset Screen</div>
          <div class="small-muted">Clears the current card on screen (not your journal).</div>
        </div>
        <button class="tiny-btn" id="resetBtn">Reset</button>
      </div>

    </div>
  </div>

<script>
  const CATEGORIES = ["All","Money","Love","Self","Healing"];

  const hints = [
    "Stay open to gentle signs.",
    "Let your heart soften first.",
    "A small shift creates a new timeline.",
    "Notice what feels warm and comforting.",
    "Take one aligned step today.",
    "Receive before you try to give.",
    "Let something be easier today than usual.",
    "Follow what feels soft and expansive."
  ];

  const summaries = [
    "Today is a day for softness.",
    "Gentle action creates new timelines.",
    "Your energy wants space, not pressure.",
    "Let ease lead your choices.",
    "You‚Äôre being guided in small, sweet ways.",
    "Receive before you rush.",
    "Tiny shifts are magic today.",
    "Choose what feels warm and true.",
    "Your heart is expanding quietly.",
    "Trust the gentle pull."
  ];

  const STORAGE = {
    journal: "angel-oracle-journal",
    theme: "angel-oracle-theme",
    daily: "angel-oracle-daily",
    lastDraw: "angel-oracle-lastDraw",
    backImg: "angel-oracle-backImg"
  };

  let prompts = [];
  let currentCategory = "All";
  let lastPrompt = null;
  let lastSummary = "";
  let lastHint = "";

  function random(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  async function init(){
    const res = await fetch("prompts.json");
    prompts = await res.json();
    renderTabs();
    wireThemePicker();
    wireJournalUI();
    wireSettingsUI();
    restoreTheme();
    restoreBackImage();
    restoreDailyMode();
  }

  function renderTabs(){
    const tabs = document.getElementById("tabs");
    tabs.innerHTML = "";
    CATEGORIES.forEach(cat=>{
      const d=document.createElement("div");
      d.className="tab"+(cat===currentCategory?" active":"");
      d.textContent=cat;
      d.onclick=()=>{
        currentCategory=cat;
        renderTabs();
        if(!isDailyLocked()) drawPrompt(false);
      };
      tabs.appendChild(d);
    });
  }

  function poolForCurrent(){
    return currentCategory==="All"
      ? prompts
      : prompts.filter(p=>p.category===currentCategory || p.category==="All");
  }

  function animateDraw(){
    const card = document.getElementById("card");
    const spark = document.getElementById("sparkle");
    card.classList.remove("pop");
    spark.style.animation = "none";
    spark.offsetHeight;
    card.classList.add("pop");
    spark.style.animation = "";
    setTimeout(()=>card.classList.remove("pop"), 380);
  }

  function playMicroEvent(category){
    const eventLayer = document.getElementById("eventLayer");
    eventLayer.className = "event";
    void eventLayer.offsetWidth;
    if(category==="Money") eventLayer.classList.add("money");
    else if(category==="Love") eventLayer.classList.add("love");
    else if(category==="Self") eventLayer.classList.add("self");
    else if(category==="Healing") eventLayer.classList.add("healing");
  }

  function renderPrompt(p, isClarify=false){
    lastPrompt = p;
    lastSummary = random(summaries);
    lastHint = random(hints);

    document.getElementById("summaryText").textContent = lastSummary;

    document.getElementById("promptText").textContent =
      isClarify ? `Clarifying Message:\n${p.text}` : p.text;

    document.getElementById("promptMeta").textContent = p.category || "";

    const energyRow = document.getElementById("energyRow");
    energyRow.innerHTML = "";
    (p.energy || []).forEach(e=>{
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.textContent = e;
      energyRow.appendChild(chip);
    });

    const actionBox = document.getElementById("actionBox");
    document.getElementById("actionText").textContent = p.action || "";
    actionBox.style.display = p.action ? "block" : "none";

    const affBox = document.getElementById("affBox");
    document.getElementById("affText").textContent = p.affirmation || "";
    affBox.style.display = p.affirmation ? "block" : "none";

    document.getElementById("hintText").textContent = lastHint;

    animateDraw();
    playMicroEvent(p.category);
  }

  function chooseFromPool(pool){
    let chosen = random(pool);
    if(lastPrompt && pool.length>1){
      while(chosen.id === lastPrompt.id){
        chosen = random(pool);
      }
    }
    return chosen;
  }

  function drawPrompt(isClarify=false){
    const pool = poolForCurrent();
    const chosen = chooseFromPool(pool);
    renderPrompt(chosen, isClarify);
    if(!isClarify) saveDailyState(chosen);
  }

  function resetScreen(){
    lastPrompt = null;
    lastSummary = "";
    lastHint = "";
    document.getElementById("summaryText").textContent="Today‚Äôs Guidance will appear here.";
    document.getElementById("promptText").textContent="Tap ‚ÄúDraw‚Äù to begin.";
    document.getElementById("promptMeta").textContent="";
    document.getElementById("energyRow").innerHTML="";
    document.getElementById("actionBox").style.display="none";
    document.getElementById("affBox").style.display="none";
    document.getElementById("hintText").textContent="Today's Hint will appear here.";
    document.getElementById("eventLayer").className="event";
  }

  /* ===== Daily Mode ===== */
  function todayKey(){
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  }
  function isDailyOn(){
    return localStorage.getItem(STORAGE.daily)==="1";
  }
  function isDailyLocked(){
    if(!isDailyOn()) return false;
    const last = JSON.parse(localStorage.getItem(STORAGE.lastDraw)||"null");
    return last && last.date===todayKey();
  }
  function saveDailyState(promptObj){
    if(!isDailyOn()) return;
    localStorage.setItem(STORAGE.lastDraw, JSON.stringify({
      date: todayKey(),
      id: promptObj.id,
      category: promptObj.category
    }));
    setDailyUI(true);
  }
  function restoreDailyMode(){
    const toggle = document.getElementById("dailyToggle");
    toggle.checked = isDailyOn();

    if(isDailyOn()){
      const last = JSON.parse(localStorage.getItem(STORAGE.lastDraw)||"null");
      if(last && last.date===todayKey()){
        const found = prompts.find(p=>p.id===last.id);
        if(found) renderPrompt(found,false);
        setDailyUI(true);
      }else{
        setDailyUI(false);
      }
    }else{
      setDailyUI(false);
    }
  }
  function setDailyUI(locked){
    const drawBtn = document.getElementById("drawBtn");
    const lab = drawBtn.querySelector(".lab"); /* ‚úÖ FIX */
    if(locked){
      drawBtn.style.opacity = ".55";
      if(lab) lab.textContent = "Draw (tomorrow)";
    }else{
      drawBtn.style.opacity = "1";
      if(lab) lab.textContent = "Draw";
    }
  }

  /* ===== Theme ===== */
  function wireThemePicker(){
    const row = document.getElementById("themeRow");
    row.querySelectorAll(".theme-pill").forEach(btn=>{
      btn.onclick=()=>{
        row.querySelectorAll(".theme-pill").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const t = btn.dataset.theme;
        document.body.setAttribute("data-theme", t);
        localStorage.setItem(STORAGE.theme, t);
        const meta = document.querySelector('meta[name="theme-color"]');
        if(t==="pink") meta.setAttribute("content","#FFEFF7");
        if(t==="blue") meta.setAttribute("content","#EAF3FF");
        if(t==="cream") meta.setAttribute("content","#FFF7EF");
      };
    });
  }
  function restoreTheme(){
    const t = localStorage.getItem(STORAGE.theme) || "pink";
    document.body.setAttribute("data-theme", t);
    document.querySelectorAll(".theme-pill").forEach(b=>{
      b.classList.toggle("active", b.dataset.theme===t);
    });
  }

  /* ===== Card Back Custom ===== */
  function restoreBackImage(){
    const data = localStorage.getItem(STORAGE.backImg);
    if(data){
      document.getElementById("cardBackImg").src = data;
    }
  }
  function wireBackUploader(){
    const up = document.getElementById("backUploader");
    up.onchange = ()=>{
      const file = up.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const dataURL = reader.result;
        document.getElementById("cardBackImg").src = dataURL;
        localStorage.setItem(STORAGE.backImg, dataURL);
      };
      reader.readAsDataURL(file);
    };
  }

  /* ===== Save + Journal ===== */
  function loadJournal(){
    try{ return JSON.parse(localStorage.getItem(STORAGE.journal) || "[]"); }
    catch(e){ return []; }
  }

  function saveEntry(){
    if(!lastPrompt) return false;
    const journal = loadJournal();
    const entry = {
      time: new Date().toISOString(),
      category: lastPrompt.category || "All",
      text: lastPrompt.text || "",
      energy: lastPrompt.energy || [],
      action: lastPrompt.action || "",
      affirmation: lastPrompt.affirmation || "",
      summary: lastSummary || "",
      hint: lastHint || ""
    };
    journal.unshift(entry);
    localStorage.setItem(STORAGE.journal, JSON.stringify(journal));
    return true;
  }

  function renderJournal(){
    const filter = document.getElementById("filterSelect").value;
    const journal = loadJournal().filter(e=>{
      return filter==="All" ? true : e.category===filter;
    });

    const list = document.getElementById("journalList");
    if(journal.length === 0){
      list.innerHTML = "<p class='small-muted'>No saved prompts yet.</p>";
      return;
    }
    list.innerHTML = journal.map(e=>`
      <div class="entry">
        <div class="date">${new Date(e.time).toLocaleString()}</div>
        <div class="tag">${e.category}</div>
        ${e.summary ? `<div><b>Guidance:</b> ${e.summary}</div>` : ""}
        <div><b>Prompt:</b> ${e.text}</div>
        ${e.energy?.length ? `<div><b>Energy:</b> ${e.energy.join(" ¬∑ ")}</div>` : ""}
        ${e.action ? `<div><b>Action:</b> ${e.action}</div>` : ""}
        ${e.affirmation ? `<div><b>Affirmation:</b> ${e.affirmation}</div>` : ""}
        ${e.hint ? `<div><b>Hint:</b> ${e.hint}</div>` : ""}
      </div>
    `).join("");
  }

  function exportJournalTXT(){
    const journal = loadJournal();
    if(journal.length===0) return;

    const txt = journal.map(e=>{
      return [
        `Date: ${new Date(e.time).toLocaleString()}`,
        `Category: ${e.category}`,
        e.summary ? `Guidance: ${e.summary}` : "",
        `Prompt: ${e.text}`,
        e.energy?.length ? `Energy: ${e.energy.join(" ¬∑ ")}` : "",
        e.action ? `Action: ${e.action}` : "",
        e.affirmation ? `Affirmation: ${e.affirmation}` : "",
        e.hint ? `Hint: ${e.hint}` : "",
        "‚Äî"
      ].filter(Boolean).join("\n");
    }).join("\n\n");

    const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="angel-oracle-journal.txt";
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function clearJournal(){
    localStorage.removeItem(STORAGE.journal);
    renderJournal();
  }

  function wireJournalUI(){
    const saveBtn = document.getElementById("saveBtn");
    const journalBtn = document.getElementById("journalBtn");
    const modal = document.getElementById("journalModal");
    const close = document.getElementById("closeJournal");
    const filterSelect = document.getElementById("filterSelect");

    saveBtn.onclick = ()=>{
      const ok = saveEntry();
      saveBtn.querySelector(".lab").textContent = ok ? "Saved!" : "Draw first";
      setTimeout(()=>saveBtn.querySelector(".lab").textContent="Save", 900);
    };

    journalBtn.onclick = ()=>{
      renderJournal();
      modal.style.display="flex";
    };

    close.onclick = ()=> modal.style.display="none";
    modal.onclick = (e)=>{ if(e.target===modal) modal.style.display="none"; };

    filterSelect.onchange = renderJournal;
    document.getElementById("exportBtn").onclick = exportJournalTXT;
    document.getElementById("clearBtn").onclick = clearJournal;
  }

  /* ===== Settings UI ===== */
  function wireSettingsUI(){
    const modal = document.getElementById("settingsModal");
    document.getElementById("openSettings").onclick = ()=> modal.style.display="flex";
    document.getElementById("closeSettings").onclick= ()=> modal.style.display="none";
    modal.onclick = (e)=>{ if(e.target===modal) modal.style.display="none"; };

    const dailyToggle = document.getElementById("dailyToggle");
    dailyToggle.onchange = ()=>{
      localStorage.setItem(STORAGE.daily, dailyToggle.checked ? "1" : "0");
      restoreDailyMode();
    };

    wireBackUploader();

    document.getElementById("restoreBackBtn").onclick = ()=>{
      localStorage.removeItem(STORAGE.backImg);
      document.getElementById("cardBackImg").src = "cards/back.png";
    };

    document.getElementById("copyBtn").onclick=()=>{
      const t = document.getElementById("promptText").textContent;
      navigator.clipboard.writeText(t);
    };

    document.getElementById("resetBtn").onclick=resetScreen;
  }

  // main buttons
  document.getElementById("drawBtn").onclick=()=>{
    if(isDailyLocked()) return;
    drawPrompt(false);
  };
  document.getElementById("clarifyBtn").onclick=()=>drawPrompt(true);

  init();
</script>

<script>
  if("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js");
  }
</script>

</body>
</html>
